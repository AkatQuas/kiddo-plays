{
  "version": 3,
  "sources": ["../../../../../../front_end/panels/sources/JavaScriptCompilerPlugin.ts"],
  "sourcesContent": ["// Copyright 2014 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as SDK from '../../core/sdk/sdk.js';\nimport * as Bindings from '../../models/bindings/bindings.js';\nimport * as Workspace from '../../models/workspace/workspace.js';\nimport * as CodeMirror from '../../third_party/codemirror.next/codemirror.next.js';\nimport * as UI from '../../ui/legacy/legacy.js';\nimport type * as TextEditor from '../../ui/components/text_editor/text_editor.js';\nimport * as Snippets from '../snippets/snippets.js';\n\nimport {Plugin} from './Plugin.js';\n\n// Plugin that tries to compile the editor content and highlights\n// compilation errors.\n\nexport class JavaScriptCompilerPlugin extends Plugin {\n  private compiling: boolean = false;\n  private recompileScheduled: boolean = false;\n  private timeout: number|null = null;\n  private message: Workspace.UISourceCode.Message|null = null;\n  private disposed: boolean = false;\n  private editor: TextEditor.TextEditor.TextEditor|null = null;\n\n  constructor(uiSourceCode: Workspace.UISourceCode.UISourceCode) {\n    super(uiSourceCode);\n  }\n\n  editorExtension(): CodeMirror.Extension {\n    return CodeMirror.EditorView.updateListener.of(update => {\n      if (update.docChanged) {\n        this.scheduleCompile();\n      }\n    });\n  }\n\n  editorInitialized(editor: TextEditor.TextEditor.TextEditor): void {\n    this.editor = editor;\n    if (this.uiSourceCode.hasCommits() || this.uiSourceCode.isDirty()) {\n      this.scheduleCompile();\n    }\n  }\n\n  static accepts(uiSourceCode: Workspace.UISourceCode.UISourceCode): boolean {\n    if (uiSourceCode.extension() === 'js') {\n      return true;\n    }\n    if (Snippets.ScriptSnippetFileSystem.isSnippetsUISourceCode(uiSourceCode)) {\n      return true;\n    }\n    for (const debuggerModel of SDK.TargetManager.TargetManager.instance().models(SDK.DebuggerModel.DebuggerModel)) {\n      if (Bindings.DebuggerWorkspaceBinding.DebuggerWorkspaceBinding.instance().scriptFile(\n              uiSourceCode, debuggerModel)) {\n        return true;\n      }\n    }\n    return false;\n  }\n\n  private scheduleCompile(): void {\n    if (this.compiling) {\n      this.recompileScheduled = true;\n      return;\n    }\n    if (this.timeout) {\n      clearTimeout(this.timeout);\n    }\n    this.timeout = window.setTimeout(this.compile.bind(this), CompileDelay);\n  }\n\n  private findRuntimeModel(): SDK.RuntimeModel.RuntimeModel|null {\n    const debuggerModels = SDK.TargetManager.TargetManager.instance().models(SDK.DebuggerModel.DebuggerModel);\n    for (let i = 0; i < debuggerModels.length; ++i) {\n      const scriptFile = Bindings.DebuggerWorkspaceBinding.DebuggerWorkspaceBinding.instance().scriptFile(\n          this.uiSourceCode, debuggerModels[i]);\n      if (scriptFile) {\n        return debuggerModels[i].runtimeModel();\n      }\n    }\n    const mainTarget = SDK.TargetManager.TargetManager.instance().mainTarget();\n    return mainTarget ? mainTarget.model(SDK.RuntimeModel.RuntimeModel) : null;\n  }\n\n  private async compile(): Promise<void> {\n    const runtimeModel = this.findRuntimeModel();\n    if (!runtimeModel || !this.editor) {\n      return;\n    }\n    const currentExecutionContext = UI.Context.Context.instance().flavor(SDK.RuntimeModel.ExecutionContext);\n    if (!currentExecutionContext) {\n      return;\n    }\n\n    if (this.editor.state.doc.length > 1024 * 100) {\n      return;\n    }\n\n    const code = this.editor.state.doc.toString();\n    const scripts =\n        Bindings.DebuggerWorkspaceBinding.DebuggerWorkspaceBinding.instance().scriptsForResource(this.uiSourceCode);\n    const isModule = scripts.reduce((v, s) => v || s.isModule === true, false);\n    if (isModule) {\n      return;\n    }\n\n    this.compiling = true;\n    const result = await runtimeModel.compileScript(code, '', false, currentExecutionContext.id);\n\n    this.compiling = false;\n    if (this.recompileScheduled) {\n      this.recompileScheduled = false;\n      this.scheduleCompile();\n      return;\n    }\n    if (this.message) {\n      this.uiSourceCode.removeMessage(this.message);\n      this.message = null;\n    }\n    if (this.disposed || !result || !result.exceptionDetails) {\n      return;\n    }\n\n    const exceptionDetails = result.exceptionDetails;\n    const text = SDK.RuntimeModel.RuntimeModel.simpleTextFromException(exceptionDetails);\n    this.message = this.uiSourceCode.addLineMessage(\n        Workspace.UISourceCode.Message.Level.Error, text, exceptionDetails.lineNumber, exceptionDetails.columnNumber);\n    this.compilationFinishedForTest();\n  }\n\n  private compilationFinishedForTest(): void {\n  }\n\n  dispose(): void {\n    if (this.message) {\n      this.uiSourceCode.removeMessage(this.message);\n    }\n    this.disposed = true;\n    if (this.timeout) {\n      clearTimeout(this.timeout);\n    }\n  }\n}\n\nexport const CompileDelay = 1000;\n"],
  "mappings": "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",
  "names": []
}
