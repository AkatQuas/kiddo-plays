{
  "version": 3,
  "sources": ["../../../../../../front_end/panels/sources/EditingLocationHistoryManager.ts"],
  "sourcesContent": ["/*\n * Copyright (C) 2014 Google Inc. All rights reserved.\n *\n * Redistribution and use in source and binary forms, with or without\n * modification, are permitted provided that the following conditions are\n * met:\n *\n *     * Redistributions of source code must retain the above copyright\n * notice, this list of conditions and the following disclaimer.\n *     * Redistributions in binary form must reproduce the above\n * copyright notice, this list of conditions and the following disclaimer\n * in the documentation and/or other materials provided with the\n * distribution.\n *     * Neither the name of Google Inc. nor the names of its\n * contributors may be used to endorse or promote products derived from\n * this software without specific prior written permission.\n *\n * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS\n * \"AS IS\" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT\n * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR\n * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT\n * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,\n * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT\n * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,\n * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY\n * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\n * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE\n * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n */\n\nimport type * as Platform from '../../core/platform/platform.js';\nimport * as Workspace from '../../models/workspace/workspace.js';\nimport type * as CodeMirror from '../../third_party/codemirror.next/codemirror.next.js';\nimport * as SourceFrame from '../../ui/legacy/components/source_frame/source_frame.js';\n\nimport type {SourcesView} from './SourcesView.js';\nimport type {UISourceCodeFrame} from './UISourceCodeFrame.js';\n\nexport const HistoryDepth = 20;\n\nexport class EditingLocationHistoryManager {\n  private readonly entries: EditingLocationHistoryEntry[] = [];\n  private current = -1;\n  private revealing = false;\n\n  constructor(private readonly sourcesView: SourcesView) {\n  }\n\n  trackSourceFrameCursorJumps(sourceFrame: UISourceCodeFrame): void {\n    sourceFrame.addEventListener(\n        SourceFrame.SourceFrame.Events.EditorUpdate, event => this.onEditorUpdate(event.data, sourceFrame));\n  }\n\n  private onEditorUpdate(update: CodeMirror.ViewUpdate, sourceFrame: UISourceCodeFrame): void {\n    if (update.docChanged) {\n      this.mapEntriesFor(sourceFrame.uiSourceCode(), update.changes);\n    }\n    const prevPos = update.startState.selection.main;\n    const newPos = update.state.selection.main;\n    const isJump = !this.revealing && prevPos.anchor !== newPos.anchor && update.transactions.some((tr): boolean => {\n      return Boolean(\n          tr.isUserEvent('select.pointer') || tr.isUserEvent('select.reveal') || tr.isUserEvent('select.search'));\n    });\n    if (isJump) {\n      this.updateCurrentState(sourceFrame.uiSourceCode(), prevPos.head);\n      if (this.entries.length > this.current + 1) {\n        this.entries.length = this.current + 1;\n      }\n      this.entries.push(new EditingLocationHistoryEntry(sourceFrame.uiSourceCode(), newPos.head));\n      this.current++;\n      if (this.entries.length > HistoryDepth) {\n        this.entries.shift();\n        this.current--;\n      }\n    }\n  }\n\n  updateCurrentState(uiSourceCode: Workspace.UISourceCode.UISourceCode, position: number): void {\n    if (!this.revealing) {\n      const top = this.current >= 0 ? this.entries[this.current] : null;\n      if (top?.matches(uiSourceCode)) {\n        top.position = position;\n      }\n    }\n  }\n\n  private mapEntriesFor(uiSourceCode: Workspace.UISourceCode.UISourceCode, change: CodeMirror.ChangeDesc): void {\n    for (const entry of this.entries) {\n      if (entry.matches(uiSourceCode)) {\n        entry.position = change.mapPos(entry.position);\n      }\n    }\n  }\n\n  private reveal(entry: EditingLocationHistoryEntry): void {\n    const uiSourceCode = Workspace.Workspace.WorkspaceImpl.instance().uiSourceCode(entry.projectId, entry.url);\n    if (uiSourceCode) {\n      this.revealing = true;\n      this.sourcesView.showSourceLocation(uiSourceCode, entry.position, false, true);\n      this.revealing = false;\n    }\n  }\n\n  rollback(): void {\n    if (this.current > 0) {\n      this.current--;\n      this.reveal(this.entries[this.current]);\n    }\n  }\n\n  rollover(): void {\n    if (this.current < this.entries.length - 1) {\n      this.current++;\n      this.reveal(this.entries[this.current]);\n    }\n  }\n\n  removeHistoryForSourceCode(uiSourceCode: Workspace.UISourceCode.UISourceCode): void {\n    for (let i = this.entries.length - 1; i >= 0; i--) {\n      if (this.entries[i].matches(uiSourceCode)) {\n        this.entries.splice(i, 1);\n        if (this.current >= i) {\n          this.current--;\n        }\n      }\n    }\n  }\n}\n\nclass EditingLocationHistoryEntry {\n  readonly projectId: string;\n  readonly url: Platform.DevToolsPath.UrlString;\n  position: number;\n\n  constructor(uiSourceCode: Workspace.UISourceCode.UISourceCode, position: number) {\n    this.projectId = uiSourceCode.project().id();\n    this.url = uiSourceCode.url();\n    this.position = position;\n  }\n\n  matches(uiSourceCode: Workspace.UISourceCode.UISourceCode): boolean {\n    return this.url === uiSourceCode.url() && this.projectId === uiSourceCode.project().id();\n  }\n}\n"],
  "mappings": "AA+BA;AAEA;AAKO,aAAM,eAAe;AAErB,2CAAoC;AAAA,EAKzC,YAA6B,aAA0B;AAA1B;AAAA;AAAA,EAJZ,UAAyC;AAAA,EAClD,UAAU;AAAA,EACV,YAAY;AAAA,EAKpB,4BAA4B,aAAsC;AAChE,gBAAY,iBACR,YAAY,YAAY,OAAO,cAAc,WAAS,KAAK,eAAe,MAAM,MAAM;AAAA;AAAA,EAGpF,eAAe,QAA+B,aAAsC;AAC1F,QAAI,OAAO,YAAY;AACrB,WAAK,cAAc,YAAY,gBAAgB,OAAO;AAAA;AAExD,UAAM,UAAU,OAAO,WAAW,UAAU;AAC5C,UAAM,SAAS,OAAO,MAAM,UAAU;AACtC,UAAM,SAAS,CAAC,KAAK,aAAa,QAAQ,WAAW,OAAO,UAAU,OAAO,aAAa,KAAK,CAAC,OAAgB;AAC9G,aAAO,QACH,GAAG,YAAY,qBAAqB,GAAG,YAAY,oBAAoB,GAAG,YAAY;AAAA;AAE5F,QAAI,QAAQ;AACV,WAAK,mBAAmB,YAAY,gBAAgB,QAAQ;AAC5D,UAAI,KAAK,QAAQ,SAAS,KAAK,UAAU,GAAG;AAC1C,aAAK,QAAQ,SAAS,KAAK,UAAU;AAAA;AAEvC,WAAK,QAAQ,KAAK,IAAI,4BAA4B,YAAY,gBAAgB,OAAO;AACrF,WAAK;AACL,UAAI,KAAK,QAAQ,SAAS,cAAc;AACtC,aAAK,QAAQ;AACb,aAAK;AAAA;AAAA;AAAA;AAAA,EAKX,mBAAmB,cAAmD,UAAwB;AAC5F,QAAI,CAAC,KAAK,WAAW;AACnB,YAAM,MAAM,KAAK,WAAW,IAAI,KAAK,QAAQ,KAAK,WAAW;AAC7D,UAAI,KAAK,QAAQ,eAAe;AAC9B,YAAI,WAAW;AAAA;AAAA;AAAA;AAAA,EAKb,cAAc,cAAmD,QAAqC;AAC5G,eAAW,SAAS,KAAK,SAAS;AAChC,UAAI,MAAM,QAAQ,eAAe;AAC/B,cAAM,WAAW,OAAO,OAAO,MAAM;AAAA;AAAA;AAAA;AAAA,EAKnC,OAAO,OAA0C;AACvD,UAAM,eAAe,UAAU,UAAU,cAAc,WAAW,aAAa,MAAM,WAAW,MAAM;AACtG,QAAI,cAAc;AAChB,WAAK,YAAY;AACjB,WAAK,YAAY,mBAAmB,cAAc,MAAM,UAAU,OAAO;AACzE,WAAK,YAAY;AAAA;AAAA;AAAA,EAIrB,WAAiB;AACf,QAAI,KAAK,UAAU,GAAG;AACpB,WAAK;AACL,WAAK,OAAO,KAAK,QAAQ,KAAK;AAAA;AAAA;AAAA,EAIlC,WAAiB;AACf,QAAI,KAAK,UAAU,KAAK,QAAQ,SAAS,GAAG;AAC1C,WAAK;AACL,WAAK,OAAO,KAAK,QAAQ,KAAK;AAAA;AAAA;AAAA,EAIlC,2BAA2B,cAAyD;AAClF,aAAS,IAAI,KAAK,QAAQ,SAAS,GAAG,KAAK,GAAG,KAAK;AACjD,UAAI,KAAK,QAAQ,GAAG,QAAQ,eAAe;AACzC,aAAK,QAAQ,OAAO,GAAG;AACvB,YAAI,KAAK,WAAW,GAAG;AACrB,eAAK;AAAA;AAAA;AAAA;AAAA;AAAA;AAOf,kCAAkC;AAAA,EACvB;AAAA,EACA;AAAA,EACT;AAAA,EAEA,YAAY,cAAmD,UAAkB;AAC/E,SAAK,YAAY,aAAa,UAAU;AACxC,SAAK,MAAM,aAAa;AACxB,SAAK,WAAW;AAAA;AAAA,EAGlB,QAAQ,cAA4D;AAClE,WAAO,KAAK,QAAQ,aAAa,SAAS,KAAK,cAAc,aAAa,UAAU;AAAA;AAAA;",
  "names": []
}
