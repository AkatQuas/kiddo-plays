{
  "version": 3,
  "sources": ["../../../../../../../front_end/ui/components/text_editor/TextEditor.ts"],
  "sourcesContent": ["// Copyright 2021 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Common from '../../../core/common/common.js';\nimport * as WindowBoundsService from '../../../services/window_bounds/window_bounds.js';\nimport * as CodeMirror from '../../../third_party/codemirror.next/codemirror.next.js';\nimport * as ThemeSupport from '../../legacy/theme_support/theme_support.js';\nimport * as LitHtml from '../../lit-html/lit-html.js';\nimport * as CodeHighlighter from '../code_highlighter/code_highlighter.js';\nimport * as ComponentHelpers from '../helpers/helpers.js';\n\nimport {baseConfiguration, dummyDarkTheme, dynamicSetting, DynamicSetting, themeSelection} from './config.js';\nimport {toLineColumn, toOffset} from './position.js';\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'devtools-text-editor': TextEditor;\n  }\n}\n\nexport class TextEditor extends HTMLElement {\n  static readonly litTagName = LitHtml.literal`devtools-text-editor`;\n\n  readonly #shadow = this.attachShadow({mode: 'open'});\n  #activeEditor: CodeMirror.EditorView|undefined = undefined;\n  #dynamicSettings: readonly DynamicSetting<unknown>[] = DynamicSetting.none;\n  #activeSettingListeners: [Common.Settings.Setting<unknown>, (event: {data: unknown}) => void][] = [];\n  #pendingState: CodeMirror.EditorState|undefined;\n  #lastScrollPos = {left: 0, top: 0};\n  #resizeTimeout = -1;\n  #resizeListener = (): void => {\n    if (this.#resizeTimeout < 0) {\n      this.#resizeTimeout = window.setTimeout(() => {\n        this.#resizeTimeout = -1;\n        if (this.#activeEditor) {\n          CodeMirror.repositionTooltips(this.#activeEditor);\n        }\n      }, 50);\n    }\n  };\n  #devtoolsResizeObserver = new ResizeObserver(this.#resizeListener);\n\n  constructor(pendingState?: CodeMirror.EditorState) {\n    super();\n    this.#pendingState = pendingState;\n    this.#shadow.adoptedStyleSheets = [CodeHighlighter.Style.default];\n  }\n\n  #createEditor(): CodeMirror.EditorView {\n    this.#activeEditor = new CodeMirror.EditorView({\n      state: this.state,\n      parent: this.#shadow,\n      root: this.#shadow,\n      dispatch: (tr: CodeMirror.Transaction): void => {\n        this.editor.update([tr]);\n        if (tr.reconfigured) {\n          this.#ensureSettingListeners();\n        }\n      },\n    });\n    this.#activeEditor.scrollDOM.scrollTop = this.#lastScrollPos.top;\n    this.#activeEditor.scrollDOM.scrollLeft = this.#lastScrollPos.left;\n    this.#activeEditor.scrollDOM.addEventListener('scroll', (event): void => {\n      this.#lastScrollPos.left = (event.target as HTMLElement).scrollLeft;\n      this.#lastScrollPos.top = (event.target as HTMLElement).scrollTop;\n    });\n    this.#ensureSettingListeners();\n    this.#startObservingResize();\n    ThemeSupport.ThemeSupport.instance().addEventListener(ThemeSupport.ThemeChangeEvent.eventName, () => {\n      const currentTheme = ThemeSupport.ThemeSupport.instance().themeName() === 'dark' ? dummyDarkTheme : [];\n      this.editor.dispatch({\n        effects: themeSelection.reconfigure(currentTheme),\n      });\n    });\n    return this.#activeEditor;\n  }\n\n  get editor(): CodeMirror.EditorView {\n    return this.#activeEditor || this.#createEditor();\n  }\n\n  dispatch(spec: CodeMirror.TransactionSpec): void {\n    return this.editor.dispatch(spec);\n  }\n\n  get state(): CodeMirror.EditorState {\n    if (this.#activeEditor) {\n      return this.#activeEditor.state;\n    }\n    if (!this.#pendingState) {\n      this.#pendingState = CodeMirror.EditorState.create({extensions: baseConfiguration('')});\n    }\n    return this.#pendingState;\n  }\n\n  set state(state: CodeMirror.EditorState) {\n    if (this.#activeEditor) {\n      this.#activeEditor.setState(state);\n    } else {\n      this.#pendingState = state;\n    }\n  }\n\n  connectedCallback(): void {\n    if (!this.#activeEditor) {\n      this.#createEditor();\n    }\n  }\n\n  disconnectedCallback(): void {\n    if (this.#activeEditor) {\n      this.#pendingState = this.#activeEditor.state;\n      this.#devtoolsResizeObserver.disconnect();\n      window.removeEventListener('resize', this.#resizeListener);\n      this.#activeEditor.destroy();\n      this.#activeEditor = undefined;\n      this.#ensureSettingListeners();\n    }\n  }\n\n  focus(): void {\n    if (this.#activeEditor) {\n      this.#activeEditor.focus();\n    }\n  }\n\n  #ensureSettingListeners(): void {\n    const dynamicSettings = this.#activeEditor ? this.#activeEditor.state.facet(dynamicSetting) : DynamicSetting.none;\n    if (dynamicSettings === this.#dynamicSettings) {\n      return;\n    }\n    this.#dynamicSettings = dynamicSettings;\n\n    for (const [setting, listener] of this.#activeSettingListeners) {\n      setting.removeChangeListener(listener);\n    }\n    this.#activeSettingListeners = [];\n\n    const settings = Common.Settings.Settings.instance();\n    for (const dynamicSetting of dynamicSettings) {\n      const handler = ({data}: {data: unknown}): void => {\n        const change = dynamicSetting.sync(this.state, data);\n        if (change && this.#activeEditor) {\n          this.#activeEditor.dispatch({effects: change});\n        }\n      };\n      const setting = settings.moduleSetting(dynamicSetting.settingName);\n      setting.addChangeListener(handler);\n      this.#activeSettingListeners.push([setting, handler]);\n    }\n  }\n\n  #startObservingResize(): void {\n    const devtoolsElement =\n        WindowBoundsService.WindowBoundsService.WindowBoundsServiceImpl.instance().getDevToolsBoundingElement();\n    if (devtoolsElement) {\n      this.#devtoolsResizeObserver.observe(devtoolsElement);\n    }\n    window.addEventListener('resize', this.#resizeListener);\n  }\n\n  revealPosition(selection: CodeMirror.EditorSelection, highlight: boolean = true): void {\n    const view = this.#activeEditor;\n    if (!view) {\n      return;\n    }\n\n    const line = view.state.doc.lineAt(selection.main.head);\n    const effects: CodeMirror.StateEffect<unknown>[] = [];\n    if (highlight) {\n      effects.push(\n          view.state.field(highlightState, false) ?\n              setHighlightLine.of(line.from) :\n              CodeMirror.StateEffect.appendConfig.of(highlightState.init(() => highlightDeco(line.from))));\n    }\n    const editorRect = view.scrollDOM.getBoundingClientRect();\n    const targetPos = view.coordsAtPos(selection.main.head);\n    if (!targetPos || targetPos.top < editorRect.top || targetPos.bottom > editorRect.bottom) {\n      effects.push(CodeMirror.EditorView.scrollIntoView(selection.main, {y: 'center'}));\n    }\n\n    view.dispatch({\n      selection,\n      effects,\n      userEvent: 'select.reveal',\n    });\n    if (highlight) {\n      const {id} = view.state.field(highlightState);\n      // Reset the highlight state if, after 2 seconds (the animation\n      // duration) it is still showing this highlight.\n      window.setTimeout(() => {\n        if (view.state.field(highlightState).id === id) {\n          view.dispatch({effects: setHighlightLine.of(null)});\n        }\n      }, 2000);\n    }\n  }\n\n  createSelection(head: {lineNumber: number, columnNumber: number}, anchor?: {\n    lineNumber: number,\n    columnNumber: number,\n  }): CodeMirror.EditorSelection {\n    const {doc} = this.state;\n    const headPos = toOffset(doc, head);\n    return CodeMirror.EditorSelection.single(anchor ? toOffset(doc, anchor) : headPos, headPos);\n  }\n\n  toLineColumn(pos: number): {lineNumber: number, columnNumber: number} {\n    return toLineColumn(this.state.doc, pos);\n  }\n\n  toOffset(pos: {lineNumber: number, columnNumber: number}): number {\n    return toOffset(this.state.doc, pos);\n  }\n}\n\nComponentHelpers.CustomElements.defineComponent('devtools-text-editor', TextEditor);\n\nconst setHighlightLine = CodeMirror.StateEffect.define<number|null>(\n    {map: (value, mapping) => value === null ? null : mapping.mapPos(value)});\n\nfunction highlightDeco(position: number): {deco: CodeMirror.DecorationSet, id: number} {\n  const deco = CodeMirror.Decoration.set(\n      [CodeMirror.Decoration.line({attributes: {class: 'cm-highlightedLine'}}).range(position)]);\n  return {deco, id: Math.floor(Math.random() * 0xfffff)};\n}\n\nconst highlightState = CodeMirror.StateField.define<{deco: CodeMirror.DecorationSet, id: number}>({\n  create: () => ({deco: CodeMirror.Decoration.none, id: 0}),\n  update(value, tr) {\n    if (!tr.changes.empty && value.deco.size) {\n      value = {deco: value.deco.map(tr.changes), id: value.id};\n    }\n    for (const effect of tr.effects) {\n      if (effect.is(setHighlightLine)) {\n        value = effect.value === null ? {deco: CodeMirror.Decoration.none, id: 0} : highlightDeco(effect.value);\n      }\n    }\n    return value;\n  },\n  provide: field => CodeMirror.EditorView.decorations.from(field, value => value.deco),\n});\n"],
  "mappings": "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",
  "names": []
}
