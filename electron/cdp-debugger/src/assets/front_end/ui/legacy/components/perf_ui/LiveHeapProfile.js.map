{
  "version": 3,
  "sources": ["../../../../../../../../front_end/ui/legacy/components/perf_ui/LiveHeapProfile.ts"],
  "sourcesContent": ["// Copyright 2019 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Common from '../../../../core/common/common.js';\nimport * as Host from '../../../../core/host/host.js';\nimport * as SDK from '../../../../core/sdk/sdk.js';\n\nimport {Memory} from './LineLevelProfile.js';\n\nlet liveHeapProfileInstance: LiveHeapProfile;\nexport class LiveHeapProfile implements Common.Runnable.Runnable,\n                                        SDK.TargetManager.SDKModelObserver<SDK.HeapProfilerModel.HeapProfilerModel> {\n  private running: boolean;\n  private sessionId: number;\n  private loadEventCallback: (arg0?: Function|null) => void;\n  private readonly setting: Common.Settings.Setting<boolean>;\n\n  private constructor() {\n    this.running = false;\n    this.sessionId = 0;\n    this.loadEventCallback = (): void => {};\n    this.setting = Common.Settings.Settings.instance().moduleSetting('memoryLiveHeapProfile');\n    this.setting.addChangeListener(event => event.data ? this.startProfiling() : this.stopProfiling());\n    if (this.setting.get()) {\n      void this.startProfiling();\n    }\n  }\n\n  static instance(opts: {forceNew: boolean|null} = {forceNew: null}): LiveHeapProfile {\n    const {forceNew} = opts;\n    if (!liveHeapProfileInstance || forceNew) {\n      liveHeapProfileInstance = new LiveHeapProfile();\n    }\n\n    return liveHeapProfileInstance;\n  }\n\n  async run(): Promise<void> {\n    return;\n  }\n\n  modelAdded(model: SDK.HeapProfilerModel.HeapProfilerModel): void {\n    void model.startSampling(1e4);\n  }\n\n  modelRemoved(_model: SDK.HeapProfilerModel.HeapProfilerModel): void {\n    // Cannot do much when the model has already been removed.\n  }\n\n  private async startProfiling(): Promise<void> {\n    if (this.running) {\n      return;\n    }\n    this.running = true;\n    const sessionId = this.sessionId;\n    SDK.TargetManager.TargetManager.instance().observeModels(SDK.HeapProfilerModel.HeapProfilerModel, this);\n    SDK.TargetManager.TargetManager.instance().addModelListener(\n        SDK.ResourceTreeModel.ResourceTreeModel, SDK.ResourceTreeModel.Events.Load, this.loadEventFired, this);\n\n    do {\n      const models = SDK.TargetManager.TargetManager.instance().models(SDK.HeapProfilerModel.HeapProfilerModel);\n      const profiles = await Promise.all(models.map(model => model.getSamplingProfile()));\n      if (sessionId !== this.sessionId) {\n        break;\n      }\n      Memory.instance().reset();\n      for (let i = 0; i < profiles.length; ++i) {\n        const profile = profiles[i];\n        if (!profile) {\n          continue;\n        }\n\n        Memory.instance().appendHeapProfile(profile, models[i].target());\n      }\n      await Promise.race([\n        new Promise(r => window.setTimeout(r, Host.InspectorFrontendHost.isUnderTest() ? 10 : 5000)),\n        new Promise(r => {\n          this.loadEventCallback = r;\n        }),\n      ]);\n    } while (sessionId === this.sessionId);\n\n    SDK.TargetManager.TargetManager.instance().unobserveModels(SDK.HeapProfilerModel.HeapProfilerModel, this);\n    SDK.TargetManager.TargetManager.instance().removeModelListener(\n        SDK.ResourceTreeModel.ResourceTreeModel, SDK.ResourceTreeModel.Events.Load, this.loadEventFired, this);\n    for (const model of SDK.TargetManager.TargetManager.instance().models(SDK.HeapProfilerModel.HeapProfilerModel)) {\n      void model.stopSampling();\n    }\n    Memory.instance().reset();\n  }\n\n  private stopProfiling(): void {\n    if (!this.running) {\n      return;\n    }\n    this.running = false;\n    this.sessionId++;\n  }\n\n  private loadEventFired(): void {\n    this.loadEventCallback();\n  }\n}\n"],
  "mappings": "AAIA;AACA;AACA;AAEA;AAEA,IAAI;AACG,6BAC6G;AAAA,EAC1G;AAAA,EACA;AAAA,EACA;AAAA,EACS;AAAA,EAET,cAAc;AACpB,SAAK,UAAU;AACf,SAAK,YAAY;AACjB,SAAK,oBAAoB,MAAY;AAAA;AACrC,SAAK,UAAU,OAAO,SAAS,SAAS,WAAW,cAAc;AACjE,SAAK,QAAQ,kBAAkB,WAAS,MAAM,OAAO,KAAK,mBAAmB,KAAK;AAClF,QAAI,KAAK,QAAQ,OAAO;AACtB,WAAK,KAAK;AAAA;AAAA;AAAA,SAIP,SAAS,OAAiC,EAAC,UAAU,QAAwB;AAClF,UAAM,EAAC,aAAY;AACnB,QAAI,CAAC,2BAA2B,UAAU;AACxC,gCAA0B,IAAI;AAAA;AAGhC,WAAO;AAAA;AAAA,QAGH,MAAqB;AACzB;AAAA;AAAA,EAGF,WAAW,OAAsD;AAC/D,SAAK,MAAM,cAAc;AAAA;AAAA,EAG3B,aAAa,QAAuD;AAAA;AAAA,QAItD,iBAAgC;AAC5C,QAAI,KAAK,SAAS;AAChB;AAAA;AAEF,SAAK,UAAU;AACf,UAAM,YAAY,KAAK;AACvB,QAAI,cAAc,cAAc,WAAW,cAAc,IAAI,kBAAkB,mBAAmB;AAClG,QAAI,cAAc,cAAc,WAAW,iBACvC,IAAI,kBAAkB,mBAAmB,IAAI,kBAAkB,OAAO,MAAM,KAAK,gBAAgB;AAErG,OAAG;AACD,YAAM,SAAS,IAAI,cAAc,cAAc,WAAW,OAAO,IAAI,kBAAkB;AACvF,YAAM,WAAW,MAAM,QAAQ,IAAI,OAAO,IAAI,WAAS,MAAM;AAC7D,UAAI,cAAc,KAAK,WAAW;AAChC;AAAA;AAEF,aAAO,WAAW;AAClB,eAAS,IAAI,GAAG,IAAI,SAAS,QAAQ,EAAE,GAAG;AACxC,cAAM,UAAU,SAAS;AACzB,YAAI,CAAC,SAAS;AACZ;AAAA;AAGF,eAAO,WAAW,kBAAkB,SAAS,OAAO,GAAG;AAAA;AAEzD,YAAM,QAAQ,KAAK;AAAA,QACjB,IAAI,QAAQ,OAAK,OAAO,WAAW,GAAG,KAAK,sBAAsB,gBAAgB,KAAK;AAAA,QACtF,IAAI,QAAQ,OAAK;AACf,eAAK,oBAAoB;AAAA;AAAA;AAAA,aAGtB,cAAc,KAAK;AAE5B,QAAI,cAAc,cAAc,WAAW,gBAAgB,IAAI,kBAAkB,mBAAmB;AACpG,QAAI,cAAc,cAAc,WAAW,oBACvC,IAAI,kBAAkB,mBAAmB,IAAI,kBAAkB,OAAO,MAAM,KAAK,gBAAgB;AACrG,eAAW,SAAS,IAAI,cAAc,cAAc,WAAW,OAAO,IAAI,kBAAkB,oBAAoB;AAC9G,WAAK,MAAM;AAAA;AAEb,WAAO,WAAW;AAAA;AAAA,EAGZ,gBAAsB;AAC5B,QAAI,CAAC,KAAK,SAAS;AACjB;AAAA;AAEF,SAAK,UAAU;AACf,SAAK;AAAA;AAAA,EAGC,iBAAuB;AAC7B,SAAK;AAAA;AAAA;",
  "names": []
}
